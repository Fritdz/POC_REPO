pipeline {
    agent any
    stages {
        stage('ST16719053N') {
            steps {
                echo 'ST16719053N: Environment is prepared. Start to rollout to TEST server'
            }
        }
        stage('ST26719053N') {
            steps {
                sh '''#!/bin/bash
                docker stop test_container || true
                docker rm test_container || true
                docker rmi BKUP-TEST-image || true
                puppet resource file /tmp/clone ensure=absent force=true
                puppet resource file /tmp/clone ensure=directory
                cd /tmp/clone
                git clone https://github.com/Fritdz/POC_REPO
                docker build -t BKUP-TEST-image /tmp/clone/POC_REPO
                docker run --name test_container -d BKUP-TEST-image
                targets=puppetclient
                locate_script='/tmp/clone/POC_REPO/6719053N_script'
                bolt script run $locate_script -t $targets -u clientadm -p user1234 --no-host-key-check --run-as root
                '''
                echo 'ST26719053N: TEST server is backup and updated'
            }
        }
        stage('ST36719053N') {
            steps {
                sh '''#!/bin/bash
                curl -ls http://TESTsvr6719053N.localdomain|head -n 1 > /tmp/TEST-result-file
                echo 'ST36719053N: Test result for TEST server is generated: TEST-resultfile '
                '''
            }
        }
        stage('ST46719053N') {
            steps {
                echo "ST46719053N: TEST server's testing result has been inspected"
                script {
                    input message: '6719053N, proceed to release the work to the next phase?', parameters: [choice(name: 'ACTION', choices: 'Proceed Production\nRollBack Test', description: 'Choose an action')]
                }
            }
        }
        stage('ST56719053N') {
            steps {
                script {
                    if (params.ACTION == 'Proceed Production') {
                        echo 'ST56719053N: Proceed to Production Phase'
                        locate_script = '/tmp/clone/POC_REPO/6719053N_script'
                        bolt script run $locate_script -t $targets -u clientadm -p user1234 --no-host-key-check --run-as root
                    }
                    if (params.ACTION == 'RollBack Test') {
                        echo 'ST56719053N: Rollback Test Server'
                        sh 'docker stop test_container || true'
                        sh 'docker rm test_container || true'
                        sh 'docker run --name test_container -d BKUP-TEST-image'
                    }
                }
            }
        }
        stage('ST66719053N') {
            steps {
                script {
                    if (params.ACTION == 'Proceed Production') {
                        echo 'ST66719053N: Production server is updated'
                    }
                    if (params.ACTION == 'RollBack Test') {
                        echo 'ST66719053N: TEST server is rollback'
                    }
                }
            }
        }
    }
}
